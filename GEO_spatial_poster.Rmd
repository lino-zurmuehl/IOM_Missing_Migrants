---
title: "Untitled"
author: "Lino Zurmuehl + Giulia Pertilli"
date: "2025-05-08"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)
library(htmltools)
library(giscoR)
library(tmap)
library(sf)
library(mapview)
library(leaflet)
install.packages("leaflet.extras2")
library(leaflet.extras2)
```

## Load Data


```{r data preprocessing}
mm_df <- read.csv("Missing_Migrants_2025.csv") %>% 
  # replace the whitespeace in column names to _
  setNames(gsub(" ", "_", names(.))) %>%
  separate(Coordinates, into = c("lat", "lon"), sep=",") %>% 
  mutate(lat = as.numeric(lat),
         lon = as.numeric(lon)) %>% 
  drop_na(lat, lon) %>%
  filter(Incident.Type == "Incident") %>% 
  mutate(Migration.Route = case_when(
    Migration.Route == "" ~ "Uncategorized",
    Migration.Route == "Western Africa / Atlantic route to the Canary Islands" 
    ~ "Atlantic route to the Canary Islands",
    TRUE ~ Migration.Route)) %>%
  filter(Country.of.Origin != "Unknown") %>% 
  rename(country = Country.of.Origin) %>% 
  group_by(country) %>% 
  summarise(count = n()) %>% 
  ungroup()

acled_df <- read.csv("acled.csv") %>%
  rename(lat = latitude, lon = longitude) %>%
  drop_na(lat, lon, country) %>%
  # drop columns exept for lat, lon, event_type, country, year, event_id
  select(lat, lon, event_type, country, year, event_id_cnty) %>% 
  group_by(country) %>% 
  summarise(count = n()) %>% 
  ungroup()
```

## Filter down to countries in mm_df


```{r filtering}
# save list of all countries in mm_df to then filter out the countries in acled_df
countries <- mm_df %>% 
  select(country) %>% 
  distinct() %>% 
  pull()

# filter out the countries in acled_df
acled_df <- acled_df %>% 
  filter(country %in% countries)
```

## Add routes

```{r}
countries <- gisco_get_countries(
  year = "2016",
  epsg = "4326",
  cache = TRUE,
  update_cache = FALSE,
  cache_dir = NULL,
  verbose = FALSE,
  resolution = "20",
  spatialtype = "RG",
  country = NULL,
  region = NULL
)

centroids <- countries %>%
  st_centroid() %>%               # geometric centroid
  select(ISO3_CODE, geometry)       # keep only ISO‑3 code + geometry

# 3. Define your five named routes as ordered ISO‑3 vectors
routes <- list(
  EasternMediterranean = c("TUR", "GRC", "CYP", "BGR"),
  CentralMediterranean = c("LBY", "TUN", "DZA", "EGY", "ITA", "MLT"),
  WesternMediterranean = c("MAR", "DZA", "ESP"),
  WesternBalkan        = c("MKD", "XKX", "MNE", "ALB", "SRB", "BIH", "HRV", "HUN", "ROU"),
  MesoamericanCorridor = c("PAN", "CRI", "NIC", "GTM", "HND", "MEX", "USA")
)

# 4. For each route, extract and order its centroids, then make a LINESTRING
route_sfgs <- lapply(routes, function(iso_vec) {
  pts <- centroids %>%
    filter(ISO3_CODE %in% iso_vec) %>%
    slice(match(iso_vec, ISO3_CODE))
  st_cast(st_combine(pts$geometry), "LINESTRING")
})

# 5. Collapse into a true sfc column
route_sfc <- st_sfc(
  sapply(route_sfgs, `[`),     # pulls each sfg out of its one‑element list
  crs = st_crs(countries)
)

# 6. Now build your sf object
routes_sf <- st_sf(
  route_name = names(route_sfgs),
  geometry   = route_sfc
)

#qtm(countries) +
 # tm_shape(routes_sf) +
  #tm_lines(col = "route_name", lwd = 2, alpha = 0.5) +
  #tm_layout(title = "Migration routes in Europe")

# map view routes
mapview(routes_sf, zcol = "route_name", lwd = 2, alpha = 0.5) +
  mapview(countries, col.regions = "grey", alpha = 0.5)
```
```{r}
# Get countries data
countries <- gisco_get_countries(
  year = "2016",
  epsg = "4326",
  cache = TRUE,
  update_cache = FALSE,
  cache_dir = NULL,
  verbose = FALSE,
  resolution = "20",
  spatialtype = "RG",
  country = NULL,
  region = NULL
)

# Add country names for labeling
countries_with_names <- countries %>%
  select(ISO3_CODE, NAME_ENGL, geometry)

# Get centroids for origin/destination points
centroids <- countries_with_names %>%
  st_centroid() %>%
  select(ISO3_CODE, NAME_ENGL, geometry)

# Define route data with more detailed structure
# For each route, define:
# - route_name: Name of the migration route
# - origin_countries: Source countries
# - transit_countries: Countries passed through
# - destination_countries: Final destination countries
# - color: Unique color for the route
route_data <- list(
  list(
    route_name = "Eastern Mediterranean",
    origin_countries = c("SYR", "IRQ", "AFG"),
    transit_countries = c("TUR", "GRC", "MKD", "SRB", "BIH", "MNE", "ALB"),
    destination_countries = c("HRV", "HUN", "ROU", "AUT", "DEU","GRC", "CYP", "BGR"),
    color = "#E64A19"  # Deep Orange/Red (for Eastern Med)
  ),
  list(
    route_name = "Central Mediterranean",
    origin_countries = c("ERI", "SDN", "NGA", "SOM"),
    transit_countries = c("LBY", "TUN", "DZA", "EGY"),
    destination_countries = c("ITA", "MLT"),
    color = "#1976D2"  # Blue (for Central Med)
  ),
  list(
    route_name = "Western Mediterranean",
    origin_countries = c("DZA", "MLI", "NER"),
    transit_countries = c("MAR"),
    destination_countries = c("ESP"),
    color = "#2E7D32"  # Green (for Western Med)
  ),
  list(
    route_name = "Mesoamerican Corridor",
    origin_countries = c("GTM", "HND", "SLV", "COL", "VEN"),
    transit_countries = c("PAN", "CRI", "NIC", "MEX"),
    destination_countries = c("USA"),
    color = "#FFA000"  # Amber/Yellow (for Mesoamerican)
  )
)

# Create a function to generate directional flows
create_flow_lines <- function(route) {
  # Function to create lines between groups of countries
  create_lines_between_groups <- function(from_countries, to_countries) {
    from_points <- centroids %>% filter(ISO3_CODE %in% from_countries)
    to_points <- centroids %>% filter(ISO3_CODE %in% to_countries)
    
    # For each origin, create lines to each destination
    lines <- list()
    for (i in 1:nrow(from_points)) {
      for (j in 1:nrow(to_points)) {
        line_coords <- rbind(
          st_coordinates(from_points$geometry[i]),
          st_coordinates(to_points$geometry[j])
        )
        lines[[length(lines) + 1]] <- st_linestring(line_coords)
      }
    }
    return(lines)
  }
  
  # Create lines from origin to transit
  origin_to_transit <- list()
  if (length(route$origin_countries) > 0 && length(route$transit_countries) > 0) {
    origin_to_transit <- create_lines_between_groups(route$origin_countries, route$transit_countries)
  }
  
  # Create lines between transit countries (in sequence if possible)
  transit_lines <- list()
  if (length(route$transit_countries) > 1) {
    for (i in 1:(length(route$transit_countries) - 1)) {
      from_country <- route$transit_countries[i]
      to_country <- route$transit_countries[i + 1]
      
      from_point <- centroids %>% filter(ISO3_CODE == from_country)
      to_point <- centroids %>% filter(ISO3_CODE == to_country)
      
      if (nrow(from_point) > 0 && nrow(to_point) > 0) {
        line_coords <- rbind(
          st_coordinates(from_point$geometry),
          st_coordinates(to_point$geometry)
        )
        transit_lines[[length(transit_lines) + 1]] <- st_linestring(line_coords)
      }
    }
  }
  
  # Create lines from transit to destination
  transit_to_dest <- list()
  if (length(route$transit_countries) > 0 && length(route$destination_countries) > 0) {
    # Use the last transit countries to connect to destinations
    last_transit_countries <- tail(route$transit_countries, min(2, length(route$transit_countries)))
    transit_to_dest <- create_lines_between_groups(last_transit_countries, route$destination_countries)
  }
  
  # If there are no transit countries, connect origins directly to destinations
  origin_to_dest <- list()
  if (length(route$transit_countries) == 0 && length(route$origin_countries) > 0 && 
      length(route$destination_countries) > 0) {
    origin_to_dest <- create_lines_between_groups(route$origin_countries, route$destination_countries)
  }
  
  # Combine all lines
  all_lines <- c(origin_to_transit, transit_lines, transit_to_dest, origin_to_dest)
  
  # Create an sf object
  if (length(all_lines) > 0) {
    sf_lines <- st_sfc(all_lines, crs = st_crs(countries))
    return(sf_lines)
  } else {
    return(NULL)
  }
}

# Process each route
all_routes_sf <- list()
route_names <- character()
route_colors <- character()

for (route in route_data) {
  route_lines <- create_flow_lines(route)
  if (!is.null(route_lines)) {
    # Create sf object for this route
    route_sf <- st_sf(
      route_name = rep(route$route_name, length(route_lines)),
      geometry = route_lines
    )
    all_routes_sf[[length(all_routes_sf) + 1]] <- route_sf
    route_names <- c(route_names, route$route_name)
    route_colors <- c(route_colors, route$color)
  }
}

# Combine all route sf objects
routes_sf <- do.call(rbind, all_routes_sf)

# Define colors for country types with stronger colors
country_type_colors <- c(
  "origin" = "#F44336",      # Red for origin countries
  "transit" = "#FF9800",     # Orange for transit countries
  "destination" = "#4CAF50"  # Green for destination countries
)

# Categorize countries by their role in migration
categorize_countries <- function() {
  # Collect all countries by type
  all_origins <- unique(unlist(lapply(route_data, function(r) r$origin_countries)))
  all_transits <- unique(unlist(lapply(route_data, function(r) r$transit_countries)))
  all_destinations <- unique(unlist(lapply(route_data, function(r) r$destination_countries)))
  
  # Handle countries that appear in multiple categories - prioritize destination > transit > origin
  all_transits <- setdiff(all_transits, all_destinations)
  all_origins <- setdiff(all_origins, c(all_destinations, all_transits))
  
  # Create a data frame mapping country codes to their types
  country_types <- data.frame(
    ISO3_CODE = c(all_origins, all_transits, all_destinations),
    country_type = c(
      rep("origin", length(all_origins)),
      rep("transit", length(all_transits)),
      rep("destination", length(all_destinations))
    ),
    stringsAsFactors = FALSE
  )
  
  return(country_types)
}

# Get country types
country_types <- categorize_countries()

# Print country categories for debugging
print(paste("Origin countries:", length(unique(country_types$ISO3_CODE[country_types$country_type == "origin"]))))
print(paste("Transit countries:", length(unique(country_types$ISO3_CODE[country_types$country_type == "transit"]))))
print(paste("Destination countries:", length(unique(country_types$ISO3_CODE[country_types$country_type == "destination"]))))
print(paste("Total categorized countries:", nrow(country_types)))

# Join country types to countries data
countries_with_types <- countries_with_names %>%
  left_join(country_types, by = "ISO3_CODE") %>%
  mutate(
    country_type = ifelse(is.na(country_type), "other", country_type),
    fill_color = case_when(
      country_type == "origin" ~ as.character(country_type_colors["origin"]),
      country_type == "transit" ~ as.character(country_type_colors["transit"]),
      country_type == "destination" ~ as.character(country_type_colors["destination"]),
      TRUE ~ "#f0f0f0"  # Light gray for other countries
    )
  )

# Create the color vector for the legend
route_colors_for_legend <- sapply(route_data, function(r) r$color)
route_names_for_legend <- sapply(route_data, function(r) r$route_name)

# Create the leaflet map
m <- leaflet() %>%
  addTiles() %>%
  # Add all countries with light color (non-migration countries)
  addPolygons(
    data = countries_with_names %>% filter(!ISO3_CODE %in% country_types$ISO3_CODE),
    fillColor = "#f0f0f0",
    fillOpacity = 0.3,
    color = "#666666",
    weight = 0.5,
    label = ~NAME_ENGL
  )

# Add countries by type with different colors (explicitly use the colors)
for (type in c("origin", "transit", "destination")) {
  countries_by_type <- countries_with_types %>% 
    filter(country_type == type)
  
  if (nrow(countries_by_type) > 0) {
    type_label <- paste0(toupper(substr(type, 1, 1)), substr(type, 2, nchar(type)))
    
    m <- m %>%
      addPolygons(
        data = countries_by_type,
        fillColor = as.character(country_type_colors[type]),  # Force string conversion
        fillOpacity = 0.7,
        color = "#333333",
        weight = 1,
        label = ~paste0(NAME_ENGL, " (", type_label, ")"),
        group = type
      )
  }
}

# Add route lines with arrows - use direct color from route_data instead of palette
for (i in 1:nrow(routes_sf)) {
  route_geom <- routes_sf$geometry[i]
  route_name <- routes_sf$route_name[i]
  
  # Find the matching route in route_data to get the exact color
  route_idx <- match(route_name, sapply(route_data, function(r) r$route_name))
  route_color <- route_data[[route_idx]]$color
  
  coords <- st_coordinates(route_geom)
  m <- m %>%
    addPolylines(
      lng = coords[, "X"],
      lat = coords[, "Y"],
      color = route_color,
      weight = 1,
      opacity = 0.9,
      label = route_name
    ) %>%
    addArrowhead(
      lng = coords[, "X"],
      lat = coords[, "Y"],
      color = route_color,
      weight = 1,
      opacity = 0.9
    )
}

# Add legends
m <- m %>%
  # Add route legend with correct colors
  addLegend(
    position = "bottomright",
    colors = route_colors_for_legend,
    labels = route_names_for_legend,
    title = "Migration Routes",
    opacity = 0.9
  ) %>%
  # Add country type legend
  addLegend(
    position = "bottomleft",
    colors = unname(country_type_colors),
    labels = c("Origin Countries", "Transit Countries", "Destination Countries"),
    title = "Country Types",
    opacity = 0.9
  ) %>%
  # Add layer controls
  addLayersControl(
    baseGroups = c(),
    overlayGroups = c("origin", "transit", "destination"),
    options = layersControlOptions(collapsed = FALSE)
  )

# Display the map
m
```

